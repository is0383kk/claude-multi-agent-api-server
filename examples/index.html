<!DOCTYPE html>
<!--
Claude Agent SDK API Test Interface

Modern, accessible web interface for testing the Claude Agent SDK API.
Features responsive design, bilingual support, and comprehensive session management.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Test interface for Claude Agent SDK API with session management">
    <title data-lang-key="page_title">Claude Agent SDK - Test Interface</title>
    <style>
        /* CSS Custom Properties for consistent theming */
        :root {
            --primary-color: #007acc;
            --primary-hover: #005a9e;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --secondary-color: #6c757d;

            --background-color: #f5f5f5;
            --card-background: #ffffff;
            --text-color: #333333;
            --text-muted: #666666;
            --border-color: #dddddd;
            --border-radius: 4px;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 8px rgba(0,0,0,0.2);

            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-mono: 'Consolas', 'Monaco', monospace;

            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 20px;
            --spacing-xl: 24px;

            --container-max-width: 1200px;
            --transition: all 0.3s ease;
        }

        /* Reset and base styles */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            max-width: var(--container-max-width);
            margin: 0 auto;
            padding: var(--spacing-lg);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            position: relative;
        }

        /* Language toggle button */
        .language-toggle {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            z-index: 1000;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
        }

        .language-toggle:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        /* Card containers */
        .card {
            background: var(--card-background);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
        }

        /* Typography */
        h1, h2 {
            color: var(--text-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: var(--spacing-lg);
        }

        h1 {
            font-size: 2rem;
            margin-bottom: var(--spacing-xl);
        }

        h2 {
            font-size: 1.5rem;
            margin-top: 0;
        }

        /* Form elements */
        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: var(--transition);
            background-color: var(--card-background);
            color: var(--text-color);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.1);
        }

        .form-control.textarea {
            min-height: 100px;
            resize: vertical;
            font-family: var(--font-family);
        }

        .form-help {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: var(--spacing-xs);
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            text-decoration: none;
            transition: var(--transition);
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: var(--danger-hover);
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        /* Status indicators */
        .status-badge {
            display: inline-block;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-running {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-completed {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-cancelled {
            background-color: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }

        /* Response areas */
        .response-area {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: var(--font-mono);
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            word-break: break-word;
        }

        /* Session items */
        .session-item {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin: 10px 0;
            background-color: #fafafa;
            transition: var(--transition);
        }

        .session-item:hover {
            box-shadow: var(--shadow);
            transform: translateY(-1px);
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .session-id {
            font-family: var(--font-mono);
            font-weight: bold;
            background-color: #e9ecef;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius);
            font-size: 0.8rem;
        }

        .session-actions {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }

        .session-actions .btn {
            margin: 0;
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        /* Advanced options */
        .advanced-options {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
            background-color: #f9f9f9;
        }

        .advanced-options summary {
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 10px;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
            background-color: var(--card-background);
            transition: var(--transition);
        }

        .advanced-options summary:hover {
            background-color: #e9ecef;
        }

        .advanced-options[open] summary {
            margin-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        /* Layout */
        .layout-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
        }

        /* Loading states */
        .loading {
            opacity: 0.7;
            pointer-events: none;
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding: var(--spacing-md);
            }

            .layout-grid {
                grid-template-columns: 1fr;
            }

            .language-toggle {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: var(--spacing-lg);
                display: block;
                width: fit-content;
                margin-left: auto;
            }

            .session-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .session-actions {
                width: 100%;
                justify-content: center;
            }

            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.25rem;
            }
        }

        @media (max-width: 480px) {
            .btn {
                width: 100%;
                margin-right: 0;
                margin-bottom: var(--spacing-sm);
            }

            .session-actions .btn {
                flex: 1;
                width: auto;
            }
        }

        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus indicators */
        .form-control:focus,
        .btn:focus,
        .language-toggle:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #000000;
                --text-color: #000000;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Language toggle button -->
    <button class="language-toggle" onclick="languageManager.toggle()" id="languageToggle" aria-label="Toggle language">
        日本語
    </button>

    <header>
        <h1 data-lang-key="main_title">Claude Agent SDK Test Interface</h1>
    </header>

    <main class="layout-grid">
        <!-- Left column: Agent execution -->
        <section>
            <article class="card">
                <h2 data-lang-key="execute_agent">Execute Agent</h2>
                <form id="executeForm" novalidate>
                    <div class="form-group">
                        <label for="prompt" class="form-label" data-lang-key="prompt_label">
                            Prompt <span aria-label="required">*</span>
                        </label>
                        <textarea
                            id="prompt"
                            name="prompt"
                            class="form-control textarea"
                            data-lang-key="prompt_placeholder"
                            placeholder="Enter the task you want Claude Agent to execute..."
                            required
                            aria-describedby="prompt-help"></textarea>
                        <div id="prompt-help" class="form-help" data-lang-key="prompt_help">
                            Describe the task you want the Claude Agent to perform
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="resume_session_id" class="form-label" data-lang-key="resume_session_label">
                            Resume Session ID (Optional)
                        </label>
                        <input
                            type="text"
                            id="resume_session_id"
                            name="resume_session_id"
                            class="form-control"
                            data-lang-key="resume_session_placeholder"
                            placeholder="Enter session ID if you want to resume an existing session"
                            aria-describedby="resume-help">
                        <div id="resume-help" class="form-help" data-lang-key="resume_session_note">
                            If specified, resumes the existing session with the same session ID
                        </div>
                    </div>

                    <details class="advanced-options">
                        <summary data-lang-key="advanced_options">Advanced Options</summary>

                        <div class="form-group">
                            <label for="permission_mode" class="form-label" data-lang-key="permission_mode_label">
                                Permission Mode
                            </label>
                            <select id="permission_mode" name="permission_mode" class="form-control">
                                <option value="" data-lang-key="permission_default">Default</option>
                                <option value="acceptEdits" data-lang-key="permission_accept">Auto-accept edits</option>
                                <option value="plan" data-lang-key="permission_plan">Plan mode</option>
                                <option value="bypassPermissions" data-lang-key="permission_bypass">Bypass permissions</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="model" class="form-label" data-lang-key="model_label">Model</label>
                            <select id="model" name="model" class="form-control">
                                <option value="" data-lang-key="model_default">Default</option>
                                <option value="sonnet">Sonnet</option>
                                <option value="opus">Opus</option>
                                <option value="haiku">Haiku</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="system_prompt" class="form-label" data-lang-key="system_prompt_label">
                                System Prompt
                            </label>
                            <textarea
                                id="system_prompt"
                                name="system_prompt"
                                class="form-control textarea"
                                data-lang-key="system_prompt_placeholder"
                                placeholder="Optional: Enter system prompt">
                            </textarea>
                        </div>

                        <div class="form-group">
                            <label for="max_turns" class="form-label" data-lang-key="max_turns_label">
                                Max Turns
                            </label>
                            <input
                                type="number"
                                id="max_turns"
                                name="max_turns"
                                class="form-control"
                                min="1"
                                max="100"
                                data-lang-key="max_turns_placeholder"
                                placeholder="Default: Unlimited">
                        </div>

                        <div class="form-group">
                            <label for="cwd" class="form-label" data-lang-key="cwd_label">
                                Working Directory
                            </label>
                            <input
                                type="text"
                                id="cwd"
                                name="cwd"
                                class="form-control"
                                data-lang-key="cwd_placeholder"
                                placeholder="Default: Server's current directory">
                        </div>

                        <div class="form-group">
                            <label for="allowed_tools" class="form-label" data-lang-key="allowed_tools_label">
                                Allowed Tools (comma-separated)
                            </label>
                            <input
                                type="text"
                                id="allowed_tools"
                                name="allowed_tools"
                                class="form-control"
                                data-lang-key="allowed_tools_placeholder"
                                placeholder="e.g: bash,read,write">
                        </div>

                        <div class="form-group">
                            <label for="disallowed_tools" class="form-label" data-lang-key="disallowed_tools_label">
                                Disallowed Tools (comma-separated)
                            </label>
                            <input
                                type="text"
                                id="disallowed_tools"
                                name="disallowed_tools"
                                class="form-control"
                                data-lang-key="disallowed_tools_placeholder"
                                placeholder="e.g: bash">
                        </div>
                    </details>

                    <div class="form-actions">
                        <button type="submit" id="executeBtn" class="btn btn-primary" data-lang-key="execute_button">
                            Execute Agent
                        </button>
                        <button type="button" onclick="sessionManager.clearResumeId()" class="btn btn-secondary" data-lang-key="new_session_button">
                            New Session
                        </button>
                    </div>
                </form>
            </article>

            <article class="card">
                <h2 data-lang-key="session_status">Session Status Check</h2>
                <div class="form-group">
                    <label for="sessionId" class="form-label" data-lang-key="session_id_label">
                        Session ID
                    </label>
                    <input
                        type="text"
                        id="sessionId"
                        class="form-control"
                        data-lang-key="session_id_placeholder"
                        placeholder="Enter session ID">
                </div>
                <div class="form-actions">
                    <button onclick="sessionManager.checkStatus()" class="btn btn-info" data-lang-key="check_status_button">
                        Check Status
                    </button>
                    <button onclick="sessionManager.cancelSession()" class="btn btn-danger" data-lang-key="cancel_session_button">
                        Cancel Session
                    </button>
                </div>

                <div id="statusResponse" class="response-area" style="display: none;" role="log" aria-live="polite">
                </div>
            </article>
        </section>

        <!-- Right column: Session management -->
        <section>
            <article class="card">
                <h2 data-lang-key="active_sessions">Active Sessions List</h2>
                <div class="form-actions">
                    <button onclick="sessionManager.loadSessions()" class="btn btn-primary" data-lang-key="refresh_list_button">
                        Refresh List
                    </button>
                    <button onclick="sessionManager.cleanupSessions()" class="btn btn-secondary" data-lang-key="cleanup_sessions_button">
                        Delete Completed Sessions
                    </button>
                </div>

                <div id="sessionsList" role="region" aria-live="polite" aria-label="Sessions list">
                    <!-- Sessions will be loaded here -->
                </div>
            </article>
        </section>
    </main>

    <script>
        // Modern ES6+ Claude Agent SDK Test Interface
        'use strict';

        // Configuration constants
        const CONFIG = {
            API_BASE: 'http://localhost:8000',
            AUTO_REFRESH_INTERVAL: 10000,
            STATUS_CHECK_INTERVAL: 3000,
            STATUS_CHECK_TIMEOUT: 60000,
            DEFAULT_STORAGE_KEY: 'claude-interface-language'
        };

        // Translation manager class
        class LanguageManager {
            constructor() {
                this.currentLanguage = localStorage.getItem(CONFIG.DEFAULT_STORAGE_KEY) || 'en';
                this.translations = {
                    en: {
                        page_title: "Claude Agent SDK - Test Interface",
                        main_title: "Claude Agent SDK Test Interface",
                        execute_agent: "Execute Agent",
                        prompt_label: "Prompt *",
                        prompt_placeholder: "Enter the task you want Claude Agent to execute...",
                        prompt_help: "Describe the task you want the Claude Agent to perform",
                        resume_session_label: "Resume Session ID (Optional)",
                        resume_session_placeholder: "Enter session ID if you want to resume an existing session",
                        resume_session_note: "If specified, resumes the existing session with the same session ID",
                        advanced_options: "Advanced Options",
                        permission_mode_label: "Permission Mode",
                        permission_default: "Default",
                        permission_accept: "Auto-accept edits",
                        permission_plan: "Plan mode",
                        permission_bypass: "Bypass permissions",
                        model_label: "Model",
                        model_default: "Default",
                        system_prompt_label: "System Prompt",
                        system_prompt_placeholder: "Optional: Enter system prompt",
                        max_turns_label: "Max Turns",
                        max_turns_placeholder: "Default: Unlimited",
                        cwd_label: "Working Directory",
                        cwd_placeholder: "Default: Server's current directory",
                        allowed_tools_label: "Allowed Tools (comma-separated)",
                        allowed_tools_placeholder: "e.g: bash,read,write",
                        disallowed_tools_label: "Disallowed Tools (comma-separated)",
                        disallowed_tools_placeholder: "e.g: bash",
                        execute_button: "Execute Agent",
                        new_session_button: "New Session",
                        session_status: "Session Status Check",
                        session_id_label: "Session ID",
                        session_id_placeholder: "Enter session ID",
                        check_status_button: "Check Status",
                        cancel_session_button: "Cancel Session",
                        active_sessions: "Active Sessions List",
                        refresh_list_button: "Refresh List",
                        cleanup_sessions_button: "Delete Completed Sessions",
                        no_active_sessions: "No active sessions",
                        resume_button: "Resume",
                        cancel_button: "Cancel",
                        status_label: "Status",
                        prompt_display: "Prompt",
                        created_label: "Created",
                        completed_label: "Completed",
                        claude_session_id_label: "Claude Session ID",
                        resume_available: "✓ Resume available",
                        claude_session_warning: "⚠ Claude session ID not yet obtained",
                        error_label: "Error",
                        confirm_cancel: "Cancel this session?",
                        confirm_cancel_by_id: "Cancel session {sessionId}?",
                        session_cancelled: "Session {sessionId} has been cancelled",
                        confirm_cleanup: "Delete completed sessions?",
                        sessions_deleted: "{count} completed sessions were deleted",
                        enter_session_id: "Please enter a session ID",
                        resume_session_text: "Resume Session",
                        execute_agent_text: "Execute Agent",
                        loading: "Loading...",
                        error_network: "Network error occurred",
                        error_server: "Server error occurred",
                        success_message: "Operation completed successfully"
                    },
                    ja: {
                        page_title: "Claude Agent SDK - テストインターフェース",
                        main_title: "Claude Agent SDK テストインターフェース",
                        execute_agent: "エージェント実行",
                        prompt_label: "プロンプト *",
                        prompt_placeholder: "Claude Agentに実行させたいタスクを入力してください...",
                        prompt_help: "Claude Agentに実行させたいタスクを説明してください",
                        resume_session_label: "セッション再開 ID (オプション)",
                        resume_session_placeholder: "既存セッションを再開したい場合はセッションIDを入力",
                        resume_session_note: "指定された場合、同一セッションIDで既存セッションを再開します",
                        advanced_options: "高度なオプション",
                        permission_mode_label: "許可モード",
                        permission_default: "デフォルト",
                        permission_accept: "編集を自動承認",
                        permission_plan: "プランモード",
                        permission_bypass: "許可をバイパス",
                        model_label: "モデル",
                        model_default: "デフォルト",
                        system_prompt_label: "システムプロンプト",
                        system_prompt_placeholder: "オプション: システムプロンプトを入力",
                        max_turns_label: "最大ターン数",
                        max_turns_placeholder: "デフォルト: 無制限",
                        cwd_label: "作業ディレクトリ",
                        cwd_placeholder: "デフォルト: サーバーの現在のディレクトリ",
                        allowed_tools_label: "許可ツール (カンマ区切り)",
                        allowed_tools_placeholder: "例: bash,read,write",
                        disallowed_tools_label: "禁止ツール (カンマ区切り)",
                        disallowed_tools_placeholder: "例: bash",
                        execute_button: "エージェントを実行",
                        new_session_button: "新規セッション",
                        session_status: "セッション状態確認",
                        session_id_label: "セッション ID",
                        session_id_placeholder: "セッションIDを入力",
                        check_status_button: "状態を確認",
                        cancel_session_button: "セッションをキャンセル",
                        active_sessions: "アクティブセッション一覧",
                        refresh_list_button: "一覧を更新",
                        cleanup_sessions_button: "完了セッションを削除",
                        no_active_sessions: "アクティブなセッションはありません",
                        resume_button: "再開",
                        cancel_button: "キャンセル",
                        status_label: "状態",
                        prompt_display: "プロンプト",
                        created_label: "作成日時",
                        completed_label: "完了日時",
                        claude_session_id_label: "Claude セッション ID",
                        resume_available: "✓ 再開可能",
                        claude_session_warning: "⚠ Claude セッション ID がまだ取得されていません",
                        error_label: "エラー",
                        confirm_cancel: "このセッションをキャンセルしますか？",
                        confirm_cancel_by_id: "セッション {sessionId} をキャンセルしますか？",
                        session_cancelled: "セッション {sessionId} がキャンセルされました",
                        confirm_cleanup: "完了したセッションを削除しますか？",
                        sessions_deleted: "{count} 個の完了セッションが削除されました",
                        enter_session_id: "セッション ID を入力してください",
                        resume_session_text: "セッションを再開",
                        execute_agent_text: "エージェントを実行",
                        loading: "読み込み中...",
                        error_network: "ネットワークエラーが発生しました",
                        error_server: "サーバーエラーが発生しました",
                        success_message: "操作が正常に完了しました"
                    }
                };
                this.init();
            }

            init() {
                this.applyLanguage(this.currentLanguage);
                this.updateToggleButton();
            }

            toggle() {
                this.currentLanguage = this.currentLanguage === 'en' ? 'ja' : 'en';
                localStorage.setItem(CONFIG.DEFAULT_STORAGE_KEY, this.currentLanguage);
                this.applyLanguage(this.currentLanguage);
                this.updateToggleButton();
            }

            applyLanguage(lang) {
                const elements = document.querySelectorAll('[data-lang-key]');
                elements.forEach(element => {
                    const key = element.getAttribute('data-lang-key');
                    const translation = this.translations[lang]?.[key];

                    if (translation) {
                        if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                            if (element.type === 'text' || element.tagName === 'TEXTAREA') {
                                element.placeholder = translation;
                            }
                        } else {
                            element.textContent = translation;
                        }
                    }
                });

                // Update HTML lang attribute and page title
                document.documentElement.lang = lang;
                document.title = this.translations[lang]['page_title'] || document.title;
            }

            updateToggleButton() {
                const toggleButton = document.getElementById('languageToggle');
                if (toggleButton) {
                    toggleButton.textContent = this.currentLanguage === 'en' ? '日本語' : 'English';
                }
            }

            get text() {
                return this.translations[this.currentLanguage];
            }

            interpolate(key, vars = {}) {
                let text = this.text[key] || key;
                Object.keys(vars).forEach(variable => {
                    text = text.replace(`{${variable}}`, vars[variable]);
                });
                return text;
            }
        }

        // Utility functions
        class Utils {
            static async request(url, options = {}) {
                try {
                    const response = await fetch(url, {
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        },
                        ...options
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Request error:', error);
                    throw error;
                }
            }

            static formatDate(dateString) {
                return new Date(dateString).toLocaleString();
            }

            static truncateText(text, maxLength = 100) {
                return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            }

            static parseToolsList(toolsString) {
                if (!toolsString) return undefined;
                return toolsString.split(',').map(s => s.trim()).filter(s => s);
            }

            static setLoading(element, loading = true) {
                if (loading) {
                    element.classList.add('loading');
                    element.disabled = true;
                } else {
                    element.classList.remove('loading');
                    element.disabled = false;
                }
            }

            static showResponse(elementId, content) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.style.display = 'block';
                    element.textContent = typeof content === 'object'
                        ? JSON.stringify(content, null, 2)
                        : content;
                }
            }

            static hideResponse(elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.style.display = 'none';
                }
            }
        }

        // Session manager class
        class SessionManager {
            constructor() {
                this.autoRefreshInterval = null;
                this.statusCheckInterval = null;
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                // Execute form submission
                const executeForm = document.getElementById('executeForm');
                if (executeForm) {
                    executeForm.addEventListener('submit', this.handleExecuteSubmit.bind(this));
                }

                // Auto-load sessions on page load
                window.addEventListener('load', () => {
                    this.loadSessions();
                    this.startAutoRefresh();
                });

                // Stop auto-refresh on page unload
                window.addEventListener('beforeunload', () => {
                    this.stopAutoRefresh();
                });
            }

            async handleExecuteSubmit(event) {
                event.preventDefault();

                const submitButton = document.getElementById('executeBtn');
                Utils.setLoading(submitButton);

                try {
                    const formData = new FormData(event.target);
                    const requestData = this.buildRequestData(formData);

                    const result = await Utils.request(`${CONFIG.API_BASE}/execute/`, {
                        method: 'POST',
                        body: JSON.stringify(requestData)
                    });

                    if (result.session_id) {
                        this.handleSuccessfulExecution(result, requestData);
                    }

                } catch (error) {
                    alert(`${languageManager.text.error_label}: ${error.message}`);
                    console.error('Execute error:', error);
                } finally {
                    Utils.setLoading(submitButton, false);
                }
            }

            buildRequestData(formData) {
                const requestData = {
                    prompt: formData.get('prompt')
                };

                // Add optional fields
                const optionalFields = [
                    'permission_mode', 'model', 'system_prompt', 'cwd', 'resume_session_id'
                ];

                optionalFields.forEach(field => {
                    const value = formData.get(field);
                    // Skip empty or whitespace-only values
                    if (value && value.trim()) {
                        if (field === 'max_turns') {
                            requestData[field] = parseInt(value);
                        } else {
                            requestData[field] = value.trim();
                        }
                    }
                });

                // Handle max_turns separately
                const maxTurns = formData.get('max_turns');
                if (maxTurns) {
                    requestData.max_turns = parseInt(maxTurns);
                }

                // Handle tool lists
                const allowedTools = Utils.parseToolsList(formData.get('allowed_tools'));
                const disallowedTools = Utils.parseToolsList(formData.get('disallowed_tools'));

                if (allowedTools) requestData.allowed_tools = allowedTools;
                if (disallowedTools) requestData.disallowed_tools = disallowedTools;

                return requestData;
            }

            handleSuccessfulExecution(result, requestData) {
                // Set session ID for status check if not resuming
                if (!requestData.resume_session_id) {
                    document.getElementById('sessionId').value = result.session_id;
                }

                // Refresh session list
                setTimeout(() => this.loadSessions(), 1000);

                // Auto-check status if resuming session
                if (requestData.resume_session_id) {
                    this.startStatusMonitoring();
                }
            }

            startStatusMonitoring() {
                setTimeout(() => {
                    this.checkStatus();
                    this.statusCheckInterval = setInterval(() => {
                        this.checkStatus();
                        this.loadSessions();
                    }, CONFIG.STATUS_CHECK_INTERVAL);

                    // Stop automatic checking after timeout
                    setTimeout(() => {
                        this.stopStatusMonitoring();
                    }, CONFIG.STATUS_CHECK_TIMEOUT);
                }, 2000);
            }

            stopStatusMonitoring() {
                if (this.statusCheckInterval) {
                    clearInterval(this.statusCheckInterval);
                    this.statusCheckInterval = null;
                }
            }

            async checkStatus() {
                const sessionId = document.getElementById('sessionId')?.value;
                if (!sessionId) {
                    alert(languageManager.text.enter_session_id);
                    return;
                }

                try {
                    const result = await Utils.request(`${CONFIG.API_BASE}/status/${sessionId}`);
                    Utils.showResponse('statusResponse', result);

                    // Update session list if status is final
                    const finalStatuses = ['completed', 'error', 'cancelled'];
                    if (finalStatuses.includes(result.status)) {
                        setTimeout(() => this.loadSessions(), 500);
                    }

                } catch (error) {
                    Utils.showResponse('statusResponse', `Error: ${error.message}`);
                    console.error('Status check error:', error);
                }
            }

            async cancelSession() {
                const sessionId = document.getElementById('sessionId')?.value;
                if (!sessionId) {
                    alert(languageManager.text.enter_session_id);
                    return;
                }

                if (!confirm(languageManager.text.confirm_cancel)) {
                    return;
                }

                try {
                    const result = await Utils.request(`${CONFIG.API_BASE}/cancel/${sessionId}`, {
                        method: 'POST'
                    });

                    Utils.showResponse('statusResponse', result);
                    setTimeout(() => this.loadSessions(), 1000);

                } catch (error) {
                    Utils.showResponse('statusResponse', `Error: ${error.message}`);
                }
            }

            async loadSessions() {
                try {
                    const sessions = await Utils.request(`${CONFIG.API_BASE}/sessions/`);
                    this.renderSessions(sessions);
                } catch (error) {
                    const sessionsList = document.getElementById('sessionsList');
                    if (sessionsList) {
                        sessionsList.innerHTML = `<p style="color: red;">Error loading sessions: ${error.message}</p>`;
                    }
                }
            }

            renderSessions(sessions) {
                const sessionsList = document.getElementById('sessionsList');
                if (!sessionsList) return;

                if (sessions.length === 0) {
                    sessionsList.innerHTML = `<p>${languageManager.text.no_active_sessions}</p>`;
                    return;
                }

                sessionsList.innerHTML = sessions.map(session => this.renderSessionItem(session)).join('');
            }

            renderSessionItem(session) {
                const truncatedPrompt = Utils.truncateText(session.prompt, 100);
                const hasClaudeSessionId = session.claude_session_id || (session.result?.session_id);
                const resumeButtonDisabled = !hasClaudeSessionId || session.status === 'running';

                return `
                    <div class="session-item">
                        <div class="session-header">
                            <span class="session-id">${session.session_id}</span>
                            <div class="session-actions">
                                <button onclick="sessionManager.resumeSession('${session.session_id}')"
                                        class="btn btn-info"
                                        ${resumeButtonDisabled ? 'disabled' : ''}>
                                    ${languageManager.text.resume_button}
                                </button>
                                <button onclick="sessionManager.cancelSessionById('${session.session_id}')"
                                        class="btn btn-danger">
                                    ${languageManager.text.cancel_button}
                                </button>
                            </div>
                        </div>
                        <div class="status-badge status-${session.status}">
                            ${languageManager.text.status_label}: ${session.status}
                        </div>
                        <div><strong>${languageManager.text.prompt_display}:</strong> ${truncatedPrompt}</div>
                        <div><strong>${languageManager.text.created_label}:</strong> ${Utils.formatDate(session.created_at)}</div>
                        ${session.end_time ? `<div><strong>${languageManager.text.completed_label}:</strong> ${Utils.formatDate(session.end_time)}</div>` : ''}
                        ${hasClaudeSessionId ?
                            `<div><strong>${languageManager.text.claude_session_id_label}:</strong>
                             <code>${hasClaudeSessionId}</code>
                             <span style="color: green;">${languageManager.text.resume_available}</span></div>` :
                            `<div style="color: orange;">${languageManager.text.claude_session_warning}</div>`
                        }
                        ${session.error ?
                            `<div style="color: red;"><strong>${languageManager.text.error_label}:</strong> ${session.error}</div>` :
                            ''
                        }
                    </div>
                `;
            }

            resumeSession(sessionId) {
                const resumeInput = document.getElementById('resume_session_id');
                const sessionIdInput = document.getElementById('sessionId');
                const executeBtn = document.getElementById('executeBtn');

                // Set resume session ID for execution
                if (resumeInput) resumeInput.value = sessionId;

                // Set session ID for status check
                if (sessionIdInput) {
                    sessionIdInput.value = sessionId;
                    this.checkStatus();
                }

                // Change execute button appearance
                if (executeBtn) {
                    executeBtn.textContent = languageManager.text.resume_session_text;
                    executeBtn.className = 'btn btn-success';
                }
            }

            clearResumeId() {
                const resumeInput = document.getElementById('resume_session_id');
                const sessionIdInput = document.getElementById('sessionId');
                const executeBtn = document.getElementById('executeBtn');

                if (resumeInput) resumeInput.value = '';
                if (sessionIdInput) sessionIdInput.value = '';

                if (executeBtn) {
                    executeBtn.textContent = languageManager.text.execute_agent_text;
                    executeBtn.className = 'btn btn-primary';
                }
            }

            async cancelSessionById(sessionId) {
                if (!confirm(languageManager.interpolate('confirm_cancel_by_id', { sessionId }))) {
                    return;
                }

                try {
                    await Utils.request(`${CONFIG.API_BASE}/cancel/${sessionId}`, {
                        method: 'POST'
                    });

                    alert(languageManager.interpolate('session_cancelled', { sessionId }));
                    this.loadSessions();

                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            }

            async cleanupSessions() {
                if (!confirm(languageManager.text.confirm_cleanup)) {
                    return;
                }

                try {
                    const result = await Utils.request(`${CONFIG.API_BASE}/sessions/cleanup?max_age_hours=0`, {
                        method: 'DELETE'
                    });

                    alert(languageManager.interpolate('sessions_deleted', { count: result.removed }));
                    this.loadSessions();

                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            }

            startAutoRefresh() {
                this.autoRefreshInterval = setInterval(() => {
                    this.loadSessions();
                }, CONFIG.AUTO_REFRESH_INTERVAL);
            }

            stopAutoRefresh() {
                if (this.autoRefreshInterval) {
                    clearInterval(this.autoRefreshInterval);
                    this.autoRefreshInterval = null;
                }
            }
        }

        // Initialize managers
        const languageManager = new LanguageManager();
        const sessionManager = new SessionManager();

        // Make managers globally accessible for inline event handlers
        window.languageManager = languageManager;
        window.sessionManager = sessionManager;

        // Initialize on DOM content loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Claude Agent SDK Test Interface initialized');

            // Add any additional initialization here
            const form = document.getElementById('executeForm');
            if (form) {
                // Add form validation
                form.addEventListener('input', (e) => {
                    if (e.target.required && !e.target.value.trim()) {
                        e.target.setCustomValidity(languageManager.text.required_field || 'This field is required');
                    } else {
                        e.target.setCustomValidity('');
                    }
                });
            }
        });
    </script>
</body>
</html>
